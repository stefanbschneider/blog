<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stefan Schneider">
<meta name="dcterms.date" content="2021-04-11">
<meta name="description" content="Building a simple image classification web app using Django and a pretrained PyTorch DenseNet model.">

<title>Stefan’s Blog - Using PyTorch Inside a Django App</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-RDWKTYTDBL"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-RDWKTYTDBL', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Stefan’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/stefanbschneider/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Using PyTorch Inside a Django App</h1>
                  <div>
        <div class="description">
          Building a simple image classification web app using Django and a pretrained PyTorch DenseNet model.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">python</div>
                <div class="quarto-category">machine learning</div>
                <div class="quarto-category">pytorch</div>
                <div class="quarto-category">django</div>
                <div class="quarto-category">deployment</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Stefan Schneider </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 11, 2021</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#initial-setup-install-django-and-pytorch" id="toc-initial-setup-install-django-and-pytorch" class="nav-link active" data-scroll-target="#initial-setup-install-django-and-pytorch">Initial Setup: Install Django and PyTorch</a></li>
  <li><a href="#pytorch-image-classification" id="toc-pytorch-image-classification" class="nav-link" data-scroll-target="#pytorch-image-classification">PyTorch Image Classification</a></li>
  <li><a href="#django-url-setup" id="toc-django-url-setup" class="nav-link" data-scroll-target="#django-url-setup">Django URL setup</a></li>
  <li><a href="#django-image-upload-classification-and-display" id="toc-django-image-upload-classification-and-display" class="nav-link" data-scroll-target="#django-image-upload-classification-and-display">Django Image Upload, Classification, and Display</a>
  <ul class="collapse">
  <li><a href="#form" id="toc-form" class="nav-link" data-scroll-target="#form">Form</a></li>
  <li><a href="#view" id="toc-view" class="nav-link" data-scroll-target="#view">View</a></li>
  <li><a href="#template" id="toc-template" class="nav-link" data-scroll-target="#template">Template</a></li>
  <li><a href="#testing-the-app-locally" id="toc-testing-the-app-locally" class="nav-link" data-scroll-target="#testing-the-app-locally">Testing the App Locally</a></li>
  </ul></li>
  <li><a href="#deployment-on-heroku" id="toc-deployment-on-heroku" class="nav-link" data-scroll-target="#deployment-on-heroku">Deployment on Heroku</a>
  <ul class="collapse">
  <li><a href="#file-structure" id="toc-file-structure" class="nav-link" data-scroll-target="#file-structure">File Structure</a></li>
  <li><a href="#setup-and-production-settings" id="toc-setup-and-production-settings" class="nav-link" data-scroll-target="#setup-and-production-settings">Setup and Production Settings</a></li>
  <li><a href="#procfile-and-requirements" id="toc-procfile-and-requirements" class="nav-link" data-scroll-target="#procfile-and-requirements">Procfile and Requirements</a></li>
  <li><a href="#static-files" id="toc-static-files" class="nav-link" data-scroll-target="#static-files">Static Files</a></li>
  <li><a href="#testing-the-deployed-app" id="toc-testing-the-deployed-app" class="nav-link" data-scroll-target="#testing-the-deployed-app">Testing the Deployed App</a></li>
  </ul></li>
  <li><a href="#what-next" id="toc-what-next" class="nav-link" data-scroll-target="#what-next">What Next?</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/stefanbschneider/blog/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>In this blog post, I build a simple image classification app using a pre-trained <a href="https://pytorch.org/hub/pytorch_vision_densenet/">DenseNet 121 model in PyTorch</a>. I deploy this image classification model inside a Django web app on Heroku.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/demo.gif" class="img-fluid figure-img" style="width:30.0%"></p>
<figcaption class="figure-caption">Image classification demo</figcaption>
</figure>
</div>
<p>This is very much related to the <a href="https://pytorch.org/tutorials/intermediate/flask_rest_api_tutorial.html">PyTorch guide on deployment with Flask</a>. Here, I show an alternative using Django, which is not as light-weight but contains more features built-in than Flask. For more information on differences between Django and Flask, see <a href="https://hackr.io/blog/flask-vs-django">this website</a>.</p>
<ul>
<li><a href="https://pytorch-django.herokuapp.com/">Deployed image classification app on Heroku</a></li>
<li><a href="https://github.com/stefanbschneider/pytorch-django">GitHub repository with final code</a></li>
<li>Related blog posts:
<ul>
<li><a href="https://stefanbschneider.github.io/blog/pytorch-getting-started">Getting started with PyTorch</a></li>
<li><a href="https://stefanbschneider.github.io/blog/django-heroku">Building and deploying Django apps on Heroku</a></li>
<li><a href="https://stefanbschneider.github.io/blog/django-google-analytics">Adding Google Analytics to a Django App</a></li>
</ul></li>
</ul>
<p>Note that my deployed app may take several seconds to load because I use Heroku’s fee dynos, which automatically power off when they are unused.</p>
<section id="initial-setup-install-django-and-pytorch" class="level2">
<h2 class="anchored" data-anchor-id="initial-setup-install-django-and-pytorch">Initial Setup: Install Django and PyTorch</h2>
<p>Requirements: Python 3, GitHub and Heroku account. Install Django and PyTorch:</p>
<pre><code>pip install django trochvision</code></pre>
<p>Create a Django project <code>pytorch_django</code> and an app <code>image_classification</code>:</p>
<pre><code>django-admin startproject pytorch_django
cd pytorch_django
python manage.py startapp image_classification</code></pre>
<p>Inside <code>settings.py</code>, add <code>'image_classification.apps.ImageClassificationConfig'</code> to the <code>INSTALLED_APPS</code> list.</p>
<p>To verify, that there are no errors yet, start the Django dev server:</p>
<pre><code>python manage.py runserver</code></pre>
<p>Go to <code>localhost:8000</code>:</p>
<p><img src="images/django-setup-complete.png" class="img-fluid"></p>
</section>
<section id="pytorch-image-classification" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-image-classification">PyTorch Image Classification</h2>
<p>To classify uploaded images, I use a <a href="https://pytorch.org/hub/pytorch_vision_densenet/">DenseNet neural network</a> that is pretrained on the <a href="http://www.image-net.org/">ImageNet dataset</a>. Since the web app is very simple and does not have any other functionality, I simply implement the image classification inside the Django <code>image_classification/views.py</code> module.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This code is taken from a <a href="https://pytorch.org/tutorials/intermediate/flask_rest_api_tutorial.html">PyTorch tutorial</a> and is under MIT license.</p>
</div>
</div>
<p>First, I load the pretrained DenseNet, switch to evaluation/inference mode (since I do not need any further training), and load the mapping for predicted indices to human-readable labels for ImageNet. The JSON-file containing the mapping is available <a href="https://s3.amazonaws.com/deep-learning-models/image-models/imagenet_class_index.json">here</a> and should be saved in the Django <code>static</code> directory under as defined in <code>STATICFILES_DIRS</code> (<code>settings.py</code>).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> io</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> models</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> django.conf <span class="im">import</span> settings</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># load pretrained DenseNet and go straight to evaluation mode for inference</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># load as global variable here, to avoid expensive reloads with each request</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> models.densenet121(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">eval</span>()</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># load mapping of ImageNet index to human-readable label (from staticfiles directory)</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># run "python manage.py collectstatic" to ensure all static files are copied to the STATICFILES_DIRS</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>json_path <span class="op">=</span> os.path.join(settings.STATIC_ROOT, <span class="st">"imagenet_class_index.json"</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>imagenet_mapping <span class="op">=</span> json.load(<span class="bu">open</span>(json_path))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is important to load the pretrained model once as global variable and not inside the view function, which would reload the model on each request (expensive and slow!).</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Loading the static JSON file via <code>settings.STATIC_ROOT</code> should work both in development and production deployment but requires running <code>python manage.py collectstatic</code> first.</p>
</div>
</div>
<p>Then, I need a function to transform an uploaded image (passed in bytes) into the required format for DenseNet, which is a 224 x 224 image with 3 RGB channels. The following code does this transformation and also normalizes the image, returning the corresponding tensor:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform_image(image_bytes):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Transform image into required DenseNet format: 224x224 with 3 RGB channels and normalized.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Return the corresponding tensor.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    my_transforms <span class="op">=</span> transforms.Compose([transforms.Resize(<span class="dv">255</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                                        transforms.CenterCrop(<span class="dv">224</span>),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                                        transforms.ToTensor(),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                                        transforms.Normalize(</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                                            [<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>],</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                                            [<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])])</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> Image.<span class="bu">open</span>(io.BytesIO(image_bytes))</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> my_transforms(image).unsqueeze(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, this function can be used inside the prediction function, where the transformed tensor of the uploaded image is passed through the pretrained DenseNet model in a forward pass. Since I only do inference here not training, I do not need a backward pass for backpropagation. The model predicts the index of the corresponding ImageNet class, which is just an integer. To display a more useful label, I retrieve the corresponding human-readable label from the <code>imagenet_mapping</code> dict that I created at the beginning from the downloaded JSON file:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_prediction(image_bytes):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""For given image bytes, predict the label using the pretrained DenseNet"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    tensor <span class="op">=</span> transform_image(image_bytes)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> model.forward(tensor)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    _, y_hat <span class="op">=</span> outputs.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    predicted_idx <span class="op">=</span> <span class="bu">str</span>(y_hat.item())</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    class_name, human_label <span class="op">=</span> imagenet_mapping[predicted_idx]</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> human_label</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="django-url-setup" class="level2">
<h2 class="anchored" data-anchor-id="django-url-setup">Django URL setup</h2>
<p>Having the PyTorch classification logic implemented in <code>image_classification/views.py</code>, I now need to integrate it into the Django app and really use it in a Django view and template. For that, I first make some adjustments in the URLs by creating a separate <code>image_classification/urls.py</code> for the URLs of the image classification app:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> django.urls <span class="im">import</span> path, include</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> django.conf <span class="im">import</span> settings</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> django.conf.urls.static <span class="im">import</span> static</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> . <span class="im">import</span> views</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>app_name <span class="op">=</span> <span class="st">'image_classification'</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>urlpatterns <span class="op">=</span> [</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># two paths: with or without given image</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    path(<span class="st">''</span>, views.index, name<span class="op">=</span><span class="st">'index'</span>),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>] <span class="op">+</span> static(settings.MEDIA_URL, document_root<span class="op">=</span>settings.MEDIA_ROOT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When visiting the main page of the web app, the requests are now directed to an <code>index</code> view, which I need to implement next and which will make use of the previous PyTorch classification logic. Before, I still need link these URLs to the project’s URLs in <code>pytorch_django/urls.py</code> such that they become effective:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>urlpatterns <span class="op">=</span> [</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    path(<span class="st">''</span>, include(<span class="st">'image_classification.urls'</span>)),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    path(<span class="st">'admin/'</span>, admin.site.urls),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="django-image-upload-classification-and-display" class="level2">
<h2 class="anchored" data-anchor-id="django-image-upload-classification-and-display">Django Image Upload, Classification, and Display</h2>
<p>Now, I implement the <code>index</code> view, which accepts an uploaded image, processes it, and passes it to the PyTorch classification logic implemented above. I also need a simple Django template to render the web interface, where users can upload an image and submit it for classification. After classification, the template needs to show the predicted label.</p>
<section id="form" class="level3">
<h3 class="anchored" data-anchor-id="form">Form</h3>
<p>For submitting uploaded images, I use a very simply Django form with an <code>ImageField</code> in <code>image_classification/forms.py</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> django <span class="im">import</span> forms</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImageUploadForm(forms.Form):</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> forms.ImageField()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="view" class="level3">
<h3 class="anchored" data-anchor-id="view">View</h3>
<p>I use this form inside my <code>index</code> view to accept uploaded images. (<code>index</code> is how I called it in my <code>image_classification/urls.py</code> but it could be any other name.) Here, I just want to display the uploaded image and pass it to the PyTorch model for classification. I do not want to (even temporarily) store it to the file system/disk. Hence, inside the view (<code>image_classification/views.py</code>), I get the image from the form, get its byte representation (for PyTorch) and create an image URI for displaying the image in the template later (see <a href="https://stackoverflow.com/a/40568024/2745116">StackOverflow</a>):</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> base64</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> django.shortcuts <span class="im">import</span> render</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .forms <span class="im">import</span> ImageUploadForm</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> index(request):</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    image_uri <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    predicted_label <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">'POST'</span>:</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in case of POST: get the uploaded image from the form and process it</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        form <span class="op">=</span> ImageUploadForm(request.POST, request.FILES)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> form.is_valid():</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># retrieve the uploaded image and convert it to bytes (for PyTorch)</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>            image <span class="op">=</span> form.cleaned_data[<span class="st">'image'</span>]</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>            image_bytes <span class="op">=</span> image.<span class="bu">file</span>.read()</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># convert and pass the image as base64 string to avoid storing it to DB or filesystem</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>            encoded_img <span class="op">=</span> base64.b64encode(image_bytes).decode(<span class="st">'ascii'</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>            image_uri <span class="op">=</span> <span class="st">'data:</span><span class="sc">%s</span><span class="st">;base64,</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> (<span class="st">'image/jpeg'</span>, encoded_img)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># get predicted label with previously implemented PyTorch function</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>                predicted_label <span class="op">=</span> get_prediction(image_bytes)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">RuntimeError</span> <span class="im">as</span> re:</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(re)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in case of GET: simply show the empty form for uploading images</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        form <span class="op">=</span> ImageUploadForm()</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pass the form, image URI, and predicted label to the template to be rendered</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> {</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">'form'</span>: form,</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">'image_uri'</span>: image_uri,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">'predicted_label'</span>: predicted_label,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render(request, <span class="st">'image_classification/index.html'</span>, context)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="template" class="level3">
<h3 class="anchored" data-anchor-id="template">Template</h3>
<p>The <code>index</code> view above calls Django’s <code>render</code> function on a template <code>image_classification/index.html</code>, which I need to create now (inside the <code>image_classification/templates</code> directory). The template needs to show the form for uploading images and, after submitting and image, the uploaded image and its predicted label.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1&gt;</span>Image Classification App<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>A simple Django web app with a pretrained PyTorch DenseNet model will try to classify the selected image according to ImageNet labels. Uploaded images are not saved.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;&lt;small&gt;</span>Further information:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">""</span> <span class="er">target</span><span class="ot">=</span><span class="st">"_blank"</span><span class="kw">&gt;</span>Blog Post<span class="kw">&lt;/a&gt;</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://github.com/stefanbschneider/pytorch-django"</span> <span class="er">target</span><span class="ot">=</span><span class="st">"_blank"</span><span class="kw">&gt;</span>GitHub<span class="kw">&lt;/a&gt;&lt;/small&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/p&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;form</span> <span class="er">method</span><span class="ot">=</span><span class="st">"post"</span> <span class="er">enctype</span><span class="ot">=</span><span class="st">"multipart/form-data"</span> <span class="er">style</span><span class="ot">=</span><span class="st">"margin-top: 50px; margin-bottom: 30px;"</span><span class="kw">&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    {% csrf_token %}</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    {{ form }}</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;button</span> <span class="er">type</span><span class="ot">=</span><span class="st">"submit"</span> <span class="er">id</span><span class="ot">=</span><span class="st">"btnUpload"</span> <span class="er">class</span><span class="ot">=</span><span class="st">"btn btn-primary"</span><span class="kw">&gt;</span>Upload<span class="kw">&lt;/button&gt;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/form&gt;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>{% if image_uri is not None %}</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    {% if predicted_label is not None %}</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;div</span> <span class="er">class</span><span class="ot">=</span><span class="st">"alert alert-primary"</span> <span class="er">role</span><span class="ot">=</span><span class="st">"alert"</span><span class="kw">&gt;</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>            Predicted label: <span class="kw">&lt;b&gt;</span>{{ predicted_label }}<span class="kw">&lt;/b&gt;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/div&gt;</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    {% else %}</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;div</span> <span class="er">class</span><span class="ot">=</span><span class="st">"alert alert-danger"</span> <span class="er">role</span><span class="ot">=</span><span class="st">"alert"</span><span class="kw">&gt;</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            Prediction error. No label predicted.</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/div&gt;</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    {% endif %}</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">"{{ image_uri }}"</span> <span class="er">class</span><span class="ot">=</span><span class="st">"img-fluid"</span> <span class="er">alt</span><span class="ot">=</span><span class="st">"Uploaded image"</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="ot">         style=</span><span class="st">"max-width: min(500px, 100%); height: auto; margin-top: 30px;"</span><span class="kw">&gt;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>{% endif %}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The uploaded image uses the saved and passed image URI from before and does not save or load any image from disk, which is important for privacy.</p>
<p>This template relies on some Bootstrap styling (see <a href="https://stefanbschneider.github.io/blog/django-bootstrap">my corresponding blog post</a>), but it is of course possible to omit that.</p>
</section>
<section id="testing-the-app-locally" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-app-locally">Testing the App Locally</h3>
<p>Running the app locally should now work without errors and show a simple page with the image upload form:</p>
<p><img src="images/image-upload.png" class="img-fluid"></p>
<p>After uploading an image, the app shows the image and its classification below:</p>
<p><img src="images/classification.png" class="img-fluid"></p>
<p>Here, it correctly classifies the image as a (tiger) cat.</p>
</section>
</section>
<section id="deployment-on-heroku" class="level2">
<h2 class="anchored" data-anchor-id="deployment-on-heroku">Deployment on Heroku</h2>
<p>For (production) deployment of this simple web app on Heroku, a few extra steps are necessary. Also refer to <a href="https://stefanbschneider.github.io/blog/django-heroku">my dedicated blog post</a> on this topic for details.</p>
<section id="file-structure" class="level3">
<h3 class="anchored" data-anchor-id="file-structure">File Structure</h3>
<p>For some reason, the default directory structure always breaks my Heroku deployment. It works, when removing the parent <code>pytorch_django</code> directory like this:</p>
<pre><code># original structure when generating the project and app
pytorch_django
    image_classification
        ...
    pytorch_django
        ...
    manage.py
README.md

# after removing the parent directory
image_classification
    ...
pytorch_django
    ...
manage.py
README.md</code></pre>
</section>
<section id="setup-and-production-settings" class="level3">
<h3 class="anchored" data-anchor-id="setup-and-production-settings">Setup and Production Settings</h3>
<p>After creating the app on Heroku and enabling automatic deploys from the corresponding GitHub repo, set the following config variables (in Heroku: Settings &gt; Config Vars):</p>
<pre><code>DJANGO_SETTINGS_MODULE: pytorch_django.prod_settings
DJANGO_SECRET_KEY: &lt;randomly-generated-secret-key&gt;</code></pre>
<p>This indicates that Heroku should use a separate <code>prod_settings.py</code> rather than the <code>settings.py</code> used for development. This <code>prod_settings.py</code> simply overwrites and disables debug mode, sets the production secret key, and allowed hosts. It also makes use of the <code>django_heroku</code> package for further settings.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> django_heroku</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># default: use settings from main settings.py if not overwritten</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .settings <span class="im">import</span> <span class="op">*</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>DEBUG <span class="op">=</span> <span class="va">False</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>SECRET_KEY <span class="op">=</span> os.getenv(<span class="st">'DJANGO_SECRET_KEY'</span>, SECRET_KEY)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># adjust this to the URL of your Heroku app</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>ALLOWED_HOSTS <span class="op">=</span> [<span class="st">'pytorch-django.herokuapp.com'</span>]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Activate Django-Heroku.</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>django_heroku.settings(<span class="bu">locals</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="procfile-and-requirements" class="level3">
<h3 class="anchored" data-anchor-id="procfile-and-requirements">Procfile and Requirements</h3>
<p>Also, add a <code>Procfile</code> in the project root that indicates how to prepare the release and deployment on Heroku using <code>gunicorn</code>:</p>
<pre><code>release: python manage.py migrate --no-input
web: gunicorn pytorch_django.wsgi</code></pre>
<p>The paths depend on the project name and directory structure.</p>
<p>Also specify the requirements that need to be installed for the app in <code>requirements.txt</code>:</p>
<pre><code>-f https://download.pytorch.org/whl/torch_stable.html
django==3.2
whitenoise==5.2.0
gunicorn==20.0.4
django-heroku==0.3.1
# cpu version of torch and torchvision for heroku to reduce slug size
torch==1.8.1+cpu
torchvision==0.9.1+cpu</code></pre>
<p>For deployment on Heroku, it’s important to use the CPU version of PyTorch since the slug size is otherwise too large (above 500 MB), which leads to a build error (see <a href="https://stackoverflow.com/a/59122860/2745116">StackOverflow</a>). The free Herku dynos only support CPU anyways.</p>
</section>
<section id="static-files" class="level3">
<h3 class="anchored" data-anchor-id="static-files">Static Files</h3>
<p>For serving static files (here, the JSON containing the ImageNet label mapping), configure <code>STATIC_ROOT</code>, <code>STATIC_URL</code>, and <code>STATICFILES_DIR</code> in <code>settings.py</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>STATIC_URL <span class="op">=</span> <span class="st">'/static/'</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># path to where static files are copied for deployment (eg, for heroku)</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>STATIC_ROOT <span class="op">=</span> os.path.join(BASE_DIR, <span class="st">'staticfiles'</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># location of static files in local development: https://learndjango.com/tutorials/django-favicon-tutorial</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>STATICFILES_DIRS <span class="op">=</span> [os.path.join(BASE_DIR, <span class="st">'static'</span>),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For production, use <code>whitenoise</code> as described <a href="https://devcenter.heroku.com/articles/django-assets#whitenoise">here</a>. Make sure to add the <code>staticfiles</code> directory to GitHub as it will not be created automatically by Django.</p>
<p>The <code>STATIC_ROOT</code> is used inside <code>views.py</code> (see above) to load the JSON file for mapping. To copy all static files from their <code>STATICFILES_DIRS</code> to <code>STATIC_ROOT</code>, run</p>
<pre><code>python manage.py collectstatic</code></pre>
<p>This is only required once locally. Heroku executes it on each deploy automatically.</p>
</section>
<section id="testing-the-deployed-app" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-deployed-app">Testing the Deployed App</h3>
<p>Check the Heroku activity/logs to see if the build and deployment are successful. After successful deployment, access the app at its URL. Mine is at <a href="https://pytorch-django.herokuapp.com/">https://pytorch-django.herokuapp.com/</a>.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Demo unavailable
</div>
</div>
<div class="callout-body-container callout-body">
<p>Unfortunately, Heroku shut down their free instances, which I used to deploy the demo. Hence, it is unavailable now.</p>
<p>You can still browse the <a href="https://github.com/stefanbschneider/pytorch-django">GitHub repository</a> with the full source code.</p>
</div>
</div>
</section>
</section>
<section id="what-next" class="level2">
<h2 class="anchored" data-anchor-id="what-next">What Next?</h2>
<p>Outcomes of this blog post:</p>
<ul>
<li><a href="https://pytorch-django.herokuapp.com/">Deployed app</a> (Now offline because Heroku shut down free instances)</li>
<li><a href="https://github.com/stefanbschneider/pytorch-django">GitHub code</a></li>
</ul>
<p>External links:</p>
<ul>
<li><a href="https://pytorch.org/tutorials/intermediate/flask_rest_api_tutorial.html">PyTorch tutorial on image classification with DenseNet and Flask</a></li>
<li><a href="https://pytorch.org/hub/pytorch_vision_densenet/">PyTorch DenseNet information</a></li>
<li><a href="http://www.image-net.org/">ImageNet dataset</a></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>