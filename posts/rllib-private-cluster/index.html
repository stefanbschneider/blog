<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stefan Schneider">
<meta name="dcterms.date" content="2021-02-15">
<meta name="description" content="Using Ray RLlib to train a deep reinforcement learning agent (PPO) in a custom environment on a private cluster.">

<title>Stefan’s Blog - Scaling Deep Reinforcement Learning to a Private Cluster</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-RDWKTYTDBL"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-RDWKTYTDBL', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Stefan’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/stefanbschneider/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Scaling Deep Reinforcement Learning to a Private Cluster</h1>
                  <div>
        <div class="description">
          Using Ray RLlib to train a deep reinforcement learning agent (PPO) in a custom environment on a private cluster.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">python</div>
                <div class="quarto-category">ray</div>
                <div class="quarto-category">machine learning</div>
                <div class="quarto-category">reinforcement learning</div>
                <div class="quarto-category">deployment</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Stefan Schneider </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 15, 2021</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#training-an-rl-agent-locally" id="toc-training-an-rl-agent-locally" class="nav-link active" data-scroll-target="#training-an-rl-agent-locally">Training an RL Agent Locally</a>
  <ul class="collapse">
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#training" id="toc-training" class="nav-link" data-scroll-target="#training">Training</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  </ul></li>
  <li><a href="#scaling-to-training-in-a-private-cluster" id="toc-scaling-to-training-in-a-private-cluster" class="nav-link" data-scroll-target="#scaling-to-training-in-a-private-cluster">Scaling to Training in a Private Cluster</a>
  <ul class="collapse">
  <li><a href="#preparations" id="toc-preparations" class="nav-link" data-scroll-target="#preparations">Preparations</a>
  <ul class="collapse">
  <li><a href="#cluster-configuration" id="toc-cluster-configuration" class="nav-link" data-scroll-target="#cluster-configuration">Cluster Configuration</a></li>
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#ssh-access" id="toc-ssh-access" class="nav-link" data-scroll-target="#ssh-access">SSH Access</a></li>
  <li><a href="#ray-command" id="toc-ray-command" class="nav-link" data-scroll-target="#ray-command"><code>ray</code> command</a></li>
  <li><a href="#connect-to-ray-cluster" id="toc-connect-to-ray-cluster" class="nav-link" data-scroll-target="#connect-to-ray-cluster">Connect to Ray cluster</a></li>
  </ul></li>
  <li><a href="#starting-the-ray-cluster" id="toc-starting-the-ray-cluster" class="nav-link" data-scroll-target="#starting-the-ray-cluster">Starting the Ray Cluster</a>
  <ul class="collapse">
  <li><a href="#on-the-local-machine" id="toc-on-the-local-machine" class="nav-link" data-scroll-target="#on-the-local-machine">On the local machine</a></li>
  <li><a href="#monitoring-training-progress" id="toc-monitoring-training-progress" class="nav-link" data-scroll-target="#monitoring-training-progress">Monitoring Training Progress</a></li>
  <li><a href="#retrieving-training-testing-results" id="toc-retrieving-training-testing-results" class="nav-link" data-scroll-target="#retrieving-training-testing-results">Retrieving Training &amp; Testing Results</a></li>
  <li><a href="#terminating-the-cluster" id="toc-terminating-the-cluster" class="nav-link" data-scroll-target="#terminating-the-cluster">Terminating the Cluster</a></li>
  </ul></li>
  <li><a href="#debugging" id="toc-debugging" class="nav-link" data-scroll-target="#debugging">Debugging</a>
  <ul class="collapse">
  <li><a href="#common-errors" id="toc-common-errors" class="nav-link" data-scroll-target="#common-errors">Common Errors</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#what-next" id="toc-what-next" class="nav-link" data-scroll-target="#what-next">What Next?</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/stefanbschneider/blog/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This post is incomplete. See the <a href="https://discuss.ray.io/t/getting-started-with-rllib-on-a-private-cluster/683">ongoing discussion</a> for details.</p>
</div>
</div>
<p>In this blog post, I use reinforcement learning (RL) to solve a custom optimization task (here, related to coordination in mobile networks). To this end, I use the scalable RL framework <a href="https://docs.ray.io/en/latest/rllib/index.html">RLlib</a>, which is part of <a href="https://github.com/ray-project/ray">Ray</a>, and a <a href="https://github.com/CN-UPB/DeepCoMP">custom environment</a>, which implements the <a href="https://gym.openai.com/">OpenAI Gym</a> interface. As RL algorithm, I use <a href="https://openai.com/blog/openai-baselines-ppo/">proximal policy optimization (PPO)</a>, which is implemented in RLlib and configured in my environment.</p>
<p>I first show how to train PPO on my environment when running locally. Then, to speed up training, I execute training on a private/on-premise multi-node cluster.</p>
<p>While it is simple in principle, it took me a while to go from running RLlib and my custom environment locally to getting it to work on a private cluster. I’m hoping this guide is useful for anyone in a similar situation. In this blog post, I focus on the general workflow but use my specific environment as an example. I will cover details about my RL approach and environment in a future blog post.</p>
<section id="training-an-rl-agent-locally" class="level1">
<h1>Training an RL Agent Locally</h1>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>Installation requires Python 3.8+ and should work on Linux, Windows, and Mac. Inside a virtualenv, install RLlib with</p>
<pre><code>pip install ray[rllib]</code></pre>
<p>Then install the custom environment. Here, <a href="https://github.com/CN-UPB/DeepCoMP">DeepCoMP</a> as described in the readme:</p>
<pre><code>pip install deepcomp</code></pre>
<p>Test the installation with <code>deepcomp -h</code>, which should show the available CLI options.</p>
</section>
<section id="training" class="level2">
<h2 class="anchored" data-anchor-id="training">Training</h2>
<p>Once installation is complete, train a centralized RL agent with PPO in an example scenario. Note, that training will take a while (around 15min on my laptop), so running the command inside a detachable GNU screen or tmux session makes sense.</p>
<pre><code>deepcomp --agent central --train-steps 100000 --env medium --slow-ues 3</code></pre>
<p>This trains a centralized PPO agent for 100k training steps running on a single core. To use more cores, set the corresponding value via CLI argument <code>--workers</code>. The additional arguments <code>--env</code> and <code>--slow-ues</code> configure my custom DeepCoMP environment (more about that in another blog post). During training, updates should be printed on screen and progress can be monitored with TensorBoard. To start TensorBoard, run (in a separate terminal):</p>
<pre><code>tensorboard --logdir results/PPO/</code></pre>
<p>Here, the TensorBoard files are in <code>results/PPO/</code>, but this depends on the environment. Once started, TensorBoard can be accessed at localhost:6006.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tensorboard.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">TensorBoard screenshot showing training progress.</figcaption>
</figure>
</div>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>In the case of my environment, results are saved in the <code>results</code> directory on the project root (where <code>deepcomp</code> is installed) by default. To specify a custom result path, use the <code>--result-dir</code> CLI argument, which accepts relative paths.</p>
<p>Files in folders prefixed with <code>PPO</code> contain neural network weights, configuration, log, and progress files generated by RLlib. They are useful for analyzing training progress or when loading a trained agent for inference (<code>--test</code> arg) or continued training (<code>--continue</code>). Additionally, folders <code>test</code> and <code>videos</code> are generated by DeepCoMP and contain easy-to-parse testing/evaluation results and rendered videos, depending on the DeepCoMP CLI args (<code>--eval</code> and <code>--video</code>).</p>
<p>Of course, this is just an example. Results are saved differently for each problem and environment.</p>
</section>
</section>
<section id="scaling-to-training-in-a-private-cluster" class="level1">
<h1>Scaling to Training in a Private Cluster</h1>
<p>The nice thing about RLlib is that it can seamlessly scale from running locally to a large cluster.</p>
<section id="preparations" class="level2">
<h2 class="anchored" data-anchor-id="preparations">Preparations</h2>
<p>While there are virtually no code changes required in the environment, some preparation steps were necessary for me to get RLlib to work on our private/on-premise cluster.</p>
<section id="cluster-configuration" class="level3">
<h3 class="anchored" data-anchor-id="cluster-configuration">Cluster Configuration</h3>
<p>The Ray cluster configuration is saved in a YAML file. My configuration file is <a href="https://github.com/CN-UPB/DeepCoMP/blob/dev/cluster.yaml">here</a>.</p>
<p>The most relevant fields concern information about the private cluster:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">provider</span><span class="kw">:</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> local</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">head_ip</span><span class="kw">:</span><span class="at"> &lt;head-machine-ip-or-address&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">worker_ips</span><span class="kw">:</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> &lt;worker1-ip&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> &lt;worker2-ip&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, <code>type: local</code> indicates that the cluster is local/private/on premise. The head IP or address points to the head node, i.e., the machine that should coordinate the cluster. To execute commands and train my RL agent, I will later attach to the head node, start training and TensorBoard, and finally retrieve results. The workers are other machines in the cluster on which the training is executed.</p>
<p>Depending on the number of workers listed under <code>worker_ips</code>, also set <code>min_workers</code> and <code>max_workers</code> to the same value.</p>
<p>For authentication when logging into the workers and distributing computation across them, also configure <code>auth</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">auth</span><span class="kw">:</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ssh_user</span><span class="kw">:</span><span class="at"> stefan</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    # Optional if an ssh private key is necessary to ssh to the cluster</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    # This is the SSH key of the local laptop, not of the head node</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ssh_private_key</span><span class="kw">:</span><span class="at"> ~/.ssh/id_rsa</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="installation" class="level3">
<h3 class="anchored" data-anchor-id="installation">Installation</h3>
<p>To run code on the workers, install <code>ray[rllib]</code> and the custom environment <code>deepcomp</code> on each worker machine of the cluster. All nodes in the cluster must have the same Python and same <code>ray</code> version (check with <code>--version</code> inside the virutalenv).</p>
<p>Maybe this can be avoided, eg, by using Docker images that are pulled automatically?</p>
</section>
<section id="ssh-access" class="level3">
<h3 class="anchored" data-anchor-id="ssh-access">SSH Access</h3>
<p>The head node needs <code>ssh</code> access to all worker nodes. Ensure the head node’s public SSH key is registered as authorized key (in <code>ssh/authorized_keys</code>) in all worker nodes. The head node’s private key path should be configured in the <code>cluster.yaml</code>.</p>
<p>In fact, the private key configured in <code>cluster.yaml</code> is the private key of the local laptop that controls the cluster. Not the head node.</p>
</section>
<section id="ray-command" class="level3">
<h3 class="anchored" data-anchor-id="ray-command"><code>ray</code> command</h3>
<p>The <code>ray</code> command needs to be available on all cluster nodes. If the <code>ray</code> command is not available on the cluster, trying to start the cluster will crash with the error <code>Command 'ray' not found ... Failed to setup head node.</code>.</p>
<p>If <code>ray</code> is installed in a virtual environment, the easiest option is to automatically source the virtualenv on each login. Particularly, adding the following line to <code>.bashrc</code> will source the virtualenv:</p>
<pre><code>source path/to/venv/bin/activate</code></pre>
<p>Where <code>path/to/venv</code> needs to point to the virtualenv. The change is in effect after log out and back in.</p>
<p>Then <code>ray --version</code> should run without errors.</p>
</section>
<section id="connect-to-ray-cluster" class="level3">
<h3 class="anchored" data-anchor-id="connect-to-ray-cluster">Connect to Ray cluster</h3>
<p>To ensure that running <code>ray</code> connects to the same cluster and the same Redis DB, use <code>ray.init(address='auto')</code>. Without argument <code>address='auto'</code>, execution on the cluster does not work.</p>
<p>However, for me, adding <code>address='auto'</code> breaks local execution. Hence, I added an optional CLI argument <code>--cluster</code> to my custom <code>deepcomp</code> environment, which adds <code>address='auto'</code> for running the environment on a cluster without code changes.</p>
</section>
</section>
<section id="starting-the-ray-cluster" class="level2">
<h2 class="anchored" data-anchor-id="starting-the-ray-cluster">Starting the Ray Cluster</h2>
<section id="on-the-local-machine" class="level3">
<h3 class="anchored" data-anchor-id="on-the-local-machine">On the local machine</h3>
<p>Start cluster:</p>
<pre><code># start the cluster (non-blocking)
ray up cluster.yaml

# forward the cluster dashboard to the local machine (this is a blocking command)
ray dashboard cluster.yaml</code></pre>
<p>View dashboard: <a href="http://localhost:8265">http://localhost:8265</a></p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This currently doesn’t work for me. It only shows the head node, not the workers.</p>
</div>
</div>
<p>Connect to cluster and run command for training. Note, you can attach but not detach. Thus, better to run this in a screen/tmux session.</p>
<pre><code>ray attach cluster.yaml
deepcomp --agent central --train-steps 100000 --env medium --slow-ues 3 --cluster --workers XY</code></pre>
<p>Once training completed, detach/close terminal with Ctrl+D.</p>
</section>
<section id="monitoring-training-progress" class="level3">
<h3 class="anchored" data-anchor-id="monitoring-training-progress">Monitoring Training Progress</h3>
<ul>
<li>Training updates should be printed inside the attached terminal</li>
<li>On the cluster’s head node, <code>htop</code> should show <code>ray::RolloutWorker</code> running.</li>
<li>On the cluster’s worker nodes, <code>htop</code> should show <code>ray::PPO()::train()</code> (or similar) to indicate the training is running.</li>
<li>Monitor progress with Tensorboard running <code>tensorboard --host 0.0.0.0 --logdir results/PPO/</code> on the cluster’s head node. Then access on <code>&lt;head-node-ip&gt;:6006</code>.</li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This currently doesn’t work for me. It seems like the program is only running on the head nodes, not at all on the workers.</p>
</div>
</div>
</section>
<section id="retrieving-training-testing-results" class="level3">
<h3 class="anchored" data-anchor-id="retrieving-training-testing-results">Retrieving Training &amp; Testing Results</h3>
<p>From the local laptop, use <code>ray rsync-down</code> to copy the result files from the cluster’s head node to the local laptop:</p>
<pre><code># ray rsync-down &lt;cluster-config&gt; &lt;source&gt; &lt;target&gt;
ray rsync-down cluster.yaml ~/DeepCoMP/results .</code></pre>
<p>Will be copied to local directory into <code>results</code>.</p>
</section>
<section id="terminating-the-cluster" class="level3">
<h3 class="anchored" data-anchor-id="terminating-the-cluster">Terminating the Cluster</h3>
<p>From the local laptop:</p>
<pre><code>ray down cluster.yaml</code></pre>
</section>
</section>
<section id="debugging" class="level2">
<h2 class="anchored" data-anchor-id="debugging">Debugging</h2>
<p>If the process above does not work, the logs may contain helpful information for debugging the problem. To print the logs, run on the cluster’s head node:</p>
<pre><code>cat /tmp/ray/session_latest/logs/monitor.*</code></pre>
<p>To print a status overview of the cluster:</p>
<pre><code> ray status --address &lt;address:port&gt;</code></pre>
<p>Where <code>&lt;address:port&gt;</code> belongs to the cluster and is displayed when starting it with <code>ray up cluster.yaml</code> (after <code>To connect to this Ray runtime from another node, run ...</code>).</p>
<section id="common-errors" class="level3">
<h3 class="anchored" data-anchor-id="common-errors">Common Errors</h3>
<ul>
<li><code>Command 'ray' not found</code> when trying to start the cluster
<ul>
<li>The <code>ray</code> command is not available on the head node after SSH. One solution is to source the virtualenv with <code>ray</code> in the <code>.bashrc</code> or to install <code>ray</code> system-wide.</li>
</ul></li>
<li>Repeatedly <code>autoscaler +4m36s) Adding 1 nodes of type ray-legacy-head-node-type.</code> when training on the cluster
<ul>
<li>??</li>
</ul></li>
<li>When trying to run code on the cluster after <code>ray attach cluster.yaml</code>: <code>(raylet) OSError: [Errno 98] Address already in use</code>
<ul>
<li>?? Is the redis server already running; something wrong with the cluster ??</li>
<li>Stopping and restarting the cluster seems to fix the problem: Detach, then from the laptop stop the cluster: <code>ray down cluster.yaml</code>, then start it again <code>ray up cluster.yaml</code></li>
</ul></li>
<li>All load seems to be just on the cluster head and nothing is distributed to the workers (when observing with <code>htop</code>)
<ul>
<li>??</li>
</ul></li>
<li>In the logs:
<ul>
<li><code>ERROR monitor.py:264 -- Monitor: Cleanup exception. Trying again...</code></li>
<li><code>1 random worker nodes will not be shut down. (due to --keep-min-workers)</code></li>
</ul></li>
</ul>
</section>
</section>
</section>
<section id="what-next" class="level1">
<h1>What Next?</h1>
<ul>
<li><a href="https://docs.ray.io/en/master/cluster/index.html#cluster-index">Ray cluster documentation</a></li>
<li><a href="https://github.com/CN-UPB/DeepCoMP">DeepCoMP GitHub repository</a></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note to self: Todos
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Test with multiple nodes on the cluster. Is there a real speedup?</li>
<li>Test running on cluster without installing env (and ray?) on workers</li>
<li>Some basic tests and proper CI (check example command from readme); update Readme with cluster instructions and link to blog; publish new release</li>
<li>Let Ray team know to distribute the blog post: https://discuss.ray.io/t/use-of-ray-logo-in-blog/797</li>
<li>Measure time to complete training when training on 1 core; 20 cores on 1 machine; 20 cores each on multiple machines
<ul>
<li>15min on 1 core</li>
<li>5 min on 20 core</li>
<li>4 min on 40 core</li>
</ul></li>
</ul>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>